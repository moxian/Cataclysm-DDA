name: IWYU 0.21 based on Clang 17

on:
  push:
    branches:
    - master

  pull_request:
    branches:
    - master
    types: [opened, reopened, synchronize, ready_for_review]

# We only care about the latest revision of a PR, so cancel all previous instances.
concurrency:
  group: iwyu-${{ github.event.pull_request.number || github.ref_name }}
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-24.04
    env:
        COMPILER: clang++-17
    steps:
    - name: install LLVM 17
      if: ${{ needs.skip-duplicates.outputs.should_skip != 'true' && github.event_name != 'pull_request' || github.event.pull_request.draft == false }}
      run: |
          sudo apt install llvm-17 llvm-17-dev llvm-17-tools clang-17 clang-tidy-17 clang-tools-17 libclang-17-dev
          sudo apt install python3-pip ninja-build cmake
    - name: checkout own repository
      uses: actions/checkout@v4
    - name: checkout IWYU repository
      uses: actions/checkout@v4
      with:
        repository: include-what-you-use/include-what-you-use
        path: include-what-you-use-src
        ref: clang_17
    - name: build IWYU
      run: |
        cd include-what-you-use-src
        mkdir -p build
        cd build
        cmake -DCMAKE_PREFIX_PATH=/usr/lib/llvm-17 ..
        cmake --build .
        ls
        cd ../..

    - name: create compilation database
      run: |
        mkdir -p build
        cd build
        cmake \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_CXX_COMPILER=$COMPILER \
            -DCMAKE_BUILD_TYPE="Release" \
            -DTILES=${TILES:-0} \
            -DSOUND=${SOUND:-0} \
            -DLOCALIZE=${LOCALIZE:-0} \
            ..
        cd ..

    - uses: ammaraskar/gcc-problem-matcher@master
    - name: run the thing
      run: |
        ls
        PATH=${PATH}:${PWD}/include-what-you-use-src/build/bin
        python include-what-you-use-src/iwyu_tool.py src/*.cpp -p build -o clang --jobs 5  -- -Xiwyu --cxx17ns -Xiwyu --mapping_file=${PWD}/tools/iwyu/cata.imp
